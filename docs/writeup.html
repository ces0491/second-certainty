<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cesaire Tobias">
<meta name="dcterms.date" content="2025-08-18">

<title>Second Certainty: Tax Management System</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="writeup_files/libs/clipboard/clipboard.min.js"></script>
<script src="writeup_files/libs/quarto-html/quarto.js"></script>
<script src="writeup_files/libs/quarto-html/popper.min.js"></script>
<script src="writeup_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="writeup_files/libs/quarto-html/anchor.min.js"></script>
<link href="writeup_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="writeup_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="writeup_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="writeup_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="writeup_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#project-description" id="toc-project-description" class="nav-link active" data-scroll-target="#project-description"><span class="header-section-number">1</span> Project Description</a></li>
  <li><a href="#technical-requirements" id="toc-technical-requirements" class="nav-link" data-scroll-target="#technical-requirements"><span class="header-section-number">2</span> Technical Requirements</a>
  <ul class="collapse">
  <li><a href="#backend" id="toc-backend" class="nav-link" data-scroll-target="#backend"><span class="header-section-number">2.1</span> Backend</a></li>
  <li><a href="#frontend" id="toc-frontend" class="nav-link" data-scroll-target="#frontend"><span class="header-section-number">2.2</span> Frontend</a></li>
  <li><a href="#development-tools" id="toc-development-tools" class="nav-link" data-scroll-target="#development-tools"><span class="header-section-number">2.3</span> Development Tools</a></li>
  </ul></li>
  <li><a href="#application-features" id="toc-application-features" class="nav-link" data-scroll-target="#application-features"><span class="header-section-number">3</span> Application Features</a>
  <ul class="collapse">
  <li><a href="#core-user-management" id="toc-core-user-management" class="nav-link" data-scroll-target="#core-user-management"><span class="header-section-number">3.1</span> Core User Management</a></li>
  <li><a href="#financial-data-management" id="toc-financial-data-management" class="nav-link" data-scroll-target="#financial-data-management"><span class="header-section-number">3.2</span> Financial Data Management</a></li>
  <li><a href="#tax-calculations" id="toc-tax-calculations" class="nav-link" data-scroll-target="#tax-calculations"><span class="header-section-number">3.3</span> Tax Calculations</a></li>
  <li><a href="#data-integration-and-management" id="toc-data-integration-and-management" class="nav-link" data-scroll-target="#data-integration-and-management"><span class="header-section-number">3.4</span> Data Integration and Management</a></li>
  <li><a href="#security-and-performance" id="toc-security-and-performance" class="nav-link" data-scroll-target="#security-and-performance"><span class="header-section-number">3.5</span> Security and Performance</a></li>
  </ul></li>
  <li><a href="#deployment" id="toc-deployment" class="nav-link" data-scroll-target="#deployment"><span class="header-section-number">4</span> Deployment</a></li>
  <li><a href="#code-repository" id="toc-code-repository" class="nav-link" data-scroll-target="#code-repository"><span class="header-section-number">5</span> Code Repository</a></li>
  <li><a href="#screenshots" id="toc-screenshots" class="nav-link" data-scroll-target="#screenshots"><span class="header-section-number">6</span> Screenshots</a>
  <ul class="collapse">
  <li><a href="#dashboard" id="toc-dashboard" class="nav-link" data-scroll-target="#dashboard"><span class="header-section-number">6.1</span> Dashboard</a></li>
  <li><a href="#income-tracking" id="toc-income-tracking" class="nav-link" data-scroll-target="#income-tracking"><span class="header-section-number">6.2</span> Income Tracking</a></li>
  <li><a href="#expense-management" id="toc-expense-management" class="nav-link" data-scroll-target="#expense-management"><span class="header-section-number">6.3</span> Expense Management</a></li>
  <li><a href="#tax-calculator" id="toc-tax-calculator" class="nav-link" data-scroll-target="#tax-calculator"><span class="header-section-number">6.4</span> Tax Calculator</a></li>
  <li><a href="#provisional-tax-planner" id="toc-provisional-tax-planner" class="nav-link" data-scroll-target="#provisional-tax-planner"><span class="header-section-number">6.5</span> Provisional Tax Planner</a></li>
  <li><a href="#profile-management" id="toc-profile-management" class="nav-link" data-scroll-target="#profile-management"><span class="header-section-number">6.6</span> Profile Management</a></li>
  </ul></li>
  <li><a href="#technical-architecture" id="toc-technical-architecture" class="nav-link" data-scroll-target="#technical-architecture"><span class="header-section-number">7</span> Technical Architecture</a>
  <ul class="collapse">
  <li><a href="#backend-architecture" id="toc-backend-architecture" class="nav-link" data-scroll-target="#backend-architecture"><span class="header-section-number">7.1</span> Backend Architecture</a></li>
  <li><a href="#frontend-architecture" id="toc-frontend-architecture" class="nav-link" data-scroll-target="#frontend-architecture"><span class="header-section-number">7.2</span> Frontend Architecture</a></li>
  <li><a href="#security-implementation" id="toc-security-implementation" class="nav-link" data-scroll-target="#security-implementation"><span class="header-section-number">7.3</span> Security Implementation</a></li>
  </ul></li>
  <li><a href="#future-enhancements" id="toc-future-enhancements" class="nav-link" data-scroll-target="#future-enhancements"><span class="header-section-number">8</span> Future Enhancements</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Second Certainty: Tax Management System</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Cesaire Tobias </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/sc_logo.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">*logo generated using OpenAI’s DALL·E model via ChatGPT (May 2025)</figcaption>
</figure>
</div>
<section id="project-description" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Project Description</h1>
<p>Second Certainty addresses one of life’s two certainties—taxes—by providing South African individuals and small businesses with an intuitive platform for managing tax liabilities throughout the fiscal year.</p>
<p>Traditional tax management often occurs reactively at year-end, leading to unexpected liabilities, missed deductions, and financial stress. This application transforms this approach by implementing a proactive, year-round tax management system that continuously calculates estimated tax liabilities based on income streams, identifies potential deductions, forecasts provisional payments, and provides optimization strategies—all in real-time.</p>
<p>The system combines up-to-date South African tax regulations with personal financial data to deliver accurate tax calculations, visualizations, and strategic recommendations, helping users optimize their tax position throughout the year rather than scrambling at tax season.</p>
</section>
<section id="technical-requirements" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Technical Requirements</h1>
<section id="backend" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="backend"><span class="header-section-number">2.1</span> Backend</h2>
<ul>
<li><strong>Framework</strong>: FastAPI 0.110.1 - chosen for its high performance, automatic documentation generation, and modern Python type annotations</li>
<li><strong>ORM</strong>: SQLAlchemy 2.0.40 - provides flexible database operations and ORM capabilities</li>
<li><strong>Validation</strong>: Pydantic 2.6.0 with pydantic-settings 2.2.1 - ensures robust data validation with minimal code</li>
<li><strong>Database</strong>: PostgreSQL (production), SQLite (development) - PostgreSQL chosen for scalability and reliability</li>
<li><strong>Authentication</strong>: JWT with HTTPBearer security and bcrypt password hashing - modern secure authentication approach</li>
<li><strong>Testing</strong>: Pytest 7.4.4 with pytest-asyncio 0.23.5 - comprehensive testing framework for Python including async support</li>
<li><strong>Documentation</strong>: OpenAPI (Swagger UI) - automatic API documentation generation</li>
<li><strong>HTTP Client</strong>: HTTPX 0.27.0 - modern async HTTP client for SARS website integration</li>
<li><strong>Web Scraping</strong>: BeautifulSoup4 4.12.3 with lxml 5.1.0 - for parsing SARS tax data</li>
<li><strong>Database Migrations</strong>: Alembic 1.13.1 - robust database schema management</li>
<li><strong>Server</strong>: Uvicorn 0.29.0 - high-performance ASGI server</li>
</ul>
</section>
<section id="frontend" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="frontend"><span class="header-section-number">2.2</span> Frontend</h2>
<ul>
<li><strong>Framework</strong>: React 18.2 - chosen for its component-based architecture and efficient rendering</li>
<li><strong>Routing</strong>: React Router 6.22.1 - provides declarative routing for React applications</li>
<li><strong>HTTP Client</strong>: Axios 1.6.7 - feature-rich HTTP client for API communication</li>
<li><strong>State Management</strong>: React Context API - built-in state management solution that avoids external dependencies</li>
<li><strong>Styling</strong>: Tailwind CSS 3.4.1 - utility-first CSS framework for rapid UI development</li>
<li><strong>Data Visualization</strong>: Recharts 2.12.0 - responsive charting library for React</li>
<li><strong>Build Tools</strong>: Create React App - simplified configuration and build process</li>
</ul>
</section>
<section id="development-tools" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="development-tools"><span class="header-section-number">2.3</span> Development Tools</h2>
<ul>
<li><strong>Code Formatting</strong>: Black 24.2.0, isort 5.13.2 - automated code formatting and import sorting</li>
<li><strong>Linting</strong>: Flake8 7.0.0 - code quality and style checking</li>
<li><strong>Environment Management</strong>: python-dotenv 1.0.1 - secure environment variable management</li>
</ul>
</section>
</section>
<section id="application-features" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Application Features</h1>
<section id="core-user-management" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="core-user-management"><span class="header-section-number">3.1</span> Core User Management</h2>
<ul>
<li><strong>Secure Authentication</strong>: JWT-based authentication system with HTTPBearer tokens and bcrypt password hashing</li>
<li><strong>User Registration and Login</strong>: Comprehensive user account management with profile customization</li>
<li><strong>Provisional Taxpayer Support</strong>: Special handling for users subject to provisional tax requirements</li>
<li><strong>Admin Features</strong>: Administrative capabilities for system management and tax data updates</li>
</ul>
</section>
<section id="financial-data-management" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="financial-data-management"><span class="header-section-number">3.2</span> Financial Data Management</h2>
<ul>
<li><strong>Multi-Source Income Tracking</strong>: Support for salary, freelance, investment, rental, and other income types</li>
<li><strong>Comprehensive Expense Management</strong>: Categorized tax-deductible expenses with predefined types and validation</li>
<li><strong>Real-time Calculations</strong>: Immediate tax liability updates as financial data changes</li>
<li><strong>Historical Data</strong>: Multi-year tax data management with automatic tax year detection</li>
</ul>
</section>
<section id="tax-calculations" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="tax-calculations"><span class="header-section-number">3.3</span> Tax Calculations</h2>
<ul>
<li><strong>South African Tax Compliance</strong>: Current tax brackets, rebates, and thresholds for all age groups</li>
<li><strong>Provisional Tax Management</strong>: Automated calculation and tracking of provisional tax payments for eligible taxpayers</li>
<li><strong>Custom Tax Scenarios</strong>: “What-if” tax calculations for financial planning</li>
<li><strong>Age-based Calculations</strong>: Automatic rebate and threshold adjustments based on user age</li>
</ul>
</section>
<section id="data-integration-and-management" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="data-integration-and-management"><span class="header-section-number">3.4</span> Data Integration and Management</h2>
<ul>
<li><strong>SARS Website Integration</strong>: Automated scraping of latest tax rates with multiple fallback strategies</li>
<li><strong>Robust Data Pipeline</strong>: Multi-tiered approach for tax data retrieval including manual fallbacks</li>
<li><strong>Database Migration System</strong>: Alembic-powered schema management for seamless updates</li>
<li><strong>Comprehensive Logging</strong>: Structured logging with file rotation and error tracking</li>
</ul>
</section>
<section id="security-and-performance" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="security-and-performance"><span class="header-section-number">3.5</span> Security and Performance</h2>
<ul>
<li><strong>Input Validation</strong>: Comprehensive data validation using Pydantic schemas</li>
<li><strong>Rate Limiting</strong>: Configurable API rate limiting to prevent abuse</li>
<li><strong>CORS Management</strong>: Secure cross-origin resource sharing configuration</li>
<li><strong>Error Handling</strong>: Standardized error responses and comprehensive exception management</li>
</ul>
</section>
</section>
<section id="deployment" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Deployment</h1>
<p>The Second Certainty application is deployed on Render’s free tier, which may result in slow initial load times after periods of inactivity. When logging in, please note that you may need to retry after <code>No response from server</code> message - this is a function of deployment on Render’s free tier which experiences “cold starts” after 15 minutes of inactivity.</p>
<p><strong>Live Application URLs:</strong> - <strong>Frontend Application</strong>: <a href="https://second-certainty.onrender.com">https://second-certainty.onrender.com</a> - <strong>Backend API</strong>: <a href="https://second-certainty-api.onrender.com">https://second-certainty-api.onrender.com</a> - <strong>API Documentation</strong>: <a href="https://second-certainty-api.onrender.com/api/docs">https://second-certainty-api.onrender.com/api/docs</a></p>
<p><strong>Performance Considerations:</strong> - Initial load times may exceed 30 seconds due to service “spin-up” on free tier - Subsequent requests are fast once the service is active - Database queries are optimized for performance despite platform limitations</p>
<p>For more detailed information on deployment, please refer to the following documentation:</p>
<ul>
<li><a href="./docs/INSTALLATION.md">Installation Guide</a>: Complete setup instructions for local development</li>
<li><a href="./docs/DEPLOYMENT.md">Deployment Guide</a>: Comprehensive production deployment instructions</li>
<li><a href="./docs/API.md">API Documentation</a>: Detailed API reference with examples</li>
</ul>
</section>
<section id="code-repository" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Code Repository</h1>
<p>The project is maintained in separate repositories for optimal development workflow:</p>
<ul>
<li><strong>Backend Repository</strong>: <a href="https://github.com/ces0491/second-certainty">https://github.com/ces0491/second-certainty</a></li>
<li><strong>Frontend Repository</strong>: <a href="https://github.com/ces0491/second-certainty-frontend">https://github.com/ces0491/second-certainty-frontend</a></li>
</ul>
<p>The repositories include comprehensive documentation covering: - <strong>Installation and Setup</strong>: Step-by-step local development environment setup - <strong>API Documentation</strong>: Complete endpoint reference with request/response examples<br>
- <strong>Database Schema</strong>: Detailed model relationships and migration procedures - <strong>Testing Framework</strong>: Unit, integration, and API testing suites - <strong>Deployment Procedures</strong>: Production deployment with security best practices</p>
</section>
<section id="screenshots" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Screenshots</h1>
<section id="dashboard" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="dashboard"><span class="header-section-number">6.1</span> Dashboard</h2>
<p><img src="./images/Dashboard.png" class="img-fluid" alt="Dashboard"> <em>The main dashboard showing key tax metrics, income/expense breakdown, and tax projection visualizations with real-time updates.</em></p>
</section>
<section id="income-tracking" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="income-tracking"><span class="header-section-number">6.2</span> Income Tracking</h2>
<p><img src="./images/Income.png" class="img-fluid" alt="Income Tracking"> <em>Comprehensive interface for managing multiple income sources with PAYE categorization and annual amount tracking.</em></p>
</section>
<section id="expense-management" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="expense-management"><span class="header-section-number">6.3</span> Expense Management</h2>
<p><img src="./images/Expenses.png" class="img-fluid" alt="Expense Management"> <em>Expense tracking interface with predefined tax-deductible categories, amount validation, and documentation support.</em></p>
</section>
<section id="tax-calculator" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="tax-calculator"><span class="header-section-number">6.4</span> Tax Calculator</h2>
<p><img src="./images/Calculator.png" class="img-fluid" alt="Tax Calculator"> <em>Interactive tax calculator showing real-time liability calculations based on current financial data with age-based rebate adjustments.</em></p>
</section>
<section id="provisional-tax-planner" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="provisional-tax-planner"><span class="header-section-number">6.5</span> Provisional Tax Planner</h2>
<p><img src="./images/Provisional.png" class="img-fluid" alt="Provisional Tax Planner"> <em>Specialized tool for calculating and tracking provisional tax payments throughout the fiscal year with due date management.</em></p>
</section>
<section id="profile-management" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="profile-management"><span class="header-section-number">6.6</span> Profile Management</h2>
<p><img src="./images/Profile.png" class="img-fluid" alt="Profile Management"> <em>User profile interface for managing personal tax information, provisional taxpayer status, and account preferences.</em></p>
</section>
</section>
<section id="technical-architecture" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Technical Architecture</h1>
<section id="backend-architecture" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="backend-architecture"><span class="header-section-number">7.1</span> Backend Architecture</h2>
<ul>
<li><strong>RESTful API Design</strong>: Clean, consistent endpoint structure following REST principles</li>
<li><strong>Modular Code Organization</strong>: Separation of concerns with dedicated modules for authentication, tax calculations, and data management</li>
<li><strong>Async Processing</strong>: Non-blocking operations for web scraping and external API calls</li>
<li><strong>Database Abstraction</strong>: SQLAlchemy ORM with migration support for schema evolution</li>
<li><strong>Error Handling</strong>: Comprehensive exception management with structured error responses</li>
</ul>
</section>
<section id="frontend-architecture" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="frontend-architecture"><span class="header-section-number">7.2</span> Frontend Architecture</h2>
<ul>
<li><strong>Component-Based Design</strong>: Reusable React components with clear separation of concerns</li>
<li><strong>State Management</strong>: Context API for global state with local component state for UI interactions</li>
<li><strong>Responsive Design</strong>: Mobile-first Tailwind CSS implementation for all screen sizes</li>
<li><strong>Data Visualization</strong>: Interactive charts and graphs using Recharts library</li>
<li><strong>API Integration</strong>: Centralized Axios configuration with error handling and retry logic</li>
</ul>
</section>
<section id="security-implementation" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="security-implementation"><span class="header-section-number">7.3</span> Security Implementation</h2>
<ul>
<li><strong>Authentication Flow</strong>: JWT tokens with HTTPBearer security and automatic token refresh</li>
<li><strong>Password Security</strong>: Bcrypt hashing with salt for secure password storage</li>
<li><strong>Input Sanitization</strong>: Comprehensive validation at both API and database levels</li>
<li><strong>CORS Configuration</strong>: Secure cross-origin resource sharing with whitelisted domains</li>
<li><strong>Rate Limiting</strong>: API endpoint protection against abuse and DDoS attacks</li>
</ul>
</section>
</section>
<section id="future-enhancements" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Future Enhancements</h1>
<ul>
<li><p><strong>Rate Limiting</strong>: Actually implement rate limiting</p></li>
<li><p><strong>Password Updates</strong>: Updating profile data is not fully supported yet</p></li>
<li><p><strong>Improve Standardization</strong>: For logging, error handling, user input sanitization</p></li>
<li><p><strong>Improve Token Validation</strong></p></li>
<li><p><strong>Complete Docstrings</strong></p></li>
<li><p><strong>Write More Tests</strong></p></li>
<li><p><strong>Mobile Application</strong>: React Native app for iOS and Android with offline capability</p></li>
<li><p><strong>Advanced Reporting</strong>: PDF generation for tax reports and provisional tax statements</p></li>
<li><p><strong>Email Notifications</strong>: Automated reminders for provisional tax due dates and tax season</p></li>
<li><p><strong>Enhanced Security</strong>: Two-factor authentication and advanced session management</p></li>
<li><p><strong>Banking Integration</strong>: Direct API connections with South African banks for automatic transaction import</p></li>
<li><p><strong>Advanced Analytics</strong>: Machine learning-powered tax optimization recommendations</p></li>
<li><p><strong>Multi-User Support</strong>: Family and business account management with role-based permissions</p></li>
<li><p><strong>Tax Practitioner Features</strong>: Professional tools for accountants and tax consultants</p></li>
<li><p><strong>SARS e-Filing Integration</strong>: Direct submission of tax returns through official SARS channels</p></li>
<li><p><strong>AI-Powered Insights</strong>: Intelligent tax planning recommendations based on financial patterns</p></li>
<li><p><strong>Expanded Tax Types</strong>: Support for additional tax types including CGT, estate duty, and VAT</p></li>
<li><p><strong>Enterprise Features</strong>: Multi-company management for large organizations and tax practitioners</p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>